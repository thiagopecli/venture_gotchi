{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Ranking - Venture Gotchi{% endblock %}

{% block content %}
<style>
    /* Estilos para o Ranking de Neg√≥cios */
    .modern-table tbody tr.highlight-row {
        background-color: rgba(255, 152, 0, 0.1) !important;
        border-left: 4px solid #ff9800;
    }

    .rank-number {
        font-weight: bold;
        width: 50px;
    }

    /* Cores do P√≥dio */
    .rank-1 { color: #FFD700; font-size: 1.2rem; } /* Ouro */
    .rank-2 { color: #C0C0C0; font-size: 1.1rem; } /* Prata */
    .rank-3 { color: #CD7F32; font-size: 1.05rem; } /* Bronze */
    
    .trophy { font-size: 1.3rem; margin-right: 5px; }

    .badge-tipo {
        font-size: 0.65rem;
        padding: 2px 6px;
        border-radius: 4px;
        text-transform: uppercase;
        font-weight: bold;
        display: inline-block;
        margin-top: 4px;
    }

    .badge-pj { background-color: #e3f2fd; color: #0d47a1; border: 1px solid #bbdefb; }
    .badge-pf { background-color: #f5f5f5; color: #616161; border: 1px solid #e0e0e0; }
    
    .font-bold { font-weight: 800 !important; }
    .me-badge {
        background: #ff9800;
        color: white;
        font-size: 0.6rem;
        padding: 2px 5px;
        border-radius: 3px;
        margin-left: 5px;
    }
</style>

<main class="dashboard-main">
    <div class="header-container">
        <h2 class="profile-title"> {{ titulo }}</h2>
        <a href="{% url 'dashboard' %}" class="btn-back-orange">‚Üê Voltar ao Dashboard</a>
    </div>

    <!-- Filtro Regional (Dispon√≠vel para todos) -->
    <section class="info-card" style="margin-bottom: 20px; border: 1px solid #2196F3;">
        <h3 style="margin-bottom: 15px; color: var(--text-main);">üåç Filtro por Regi√£o</h3>
        <form method="GET" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <input type="hidden" name="criterio" value="{{ criterio }}">
            {% if is_educador and filtro_turma %}
                <input type="hidden" name="codigo_turma" value="{{ filtro_turma }}">
            {% endif %}
            
            <div>
                <label for="pais" style="font-weight: 700; color: var(--text-main); display: block; margin-bottom: 5px;">Pa√≠s:</label>
                <select name="pais" id="pais" style="width: 100%; padding: 8px; margin-bottom: 0;">
                    <option value="">Todos os pa√≠ses</option>
                    {% for pais in paises_disponiveis %}
                        <option value="{{ pais }}" {% if filtro_pais == pais %}selected{% endif %}>{{ pais }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div>
                <label for="estado" style="font-weight: 700; color: var(--text-main); display: block; margin-bottom: 5px;">Estado:</label>
                <select name="estado" id="estado" style="width: 100%; padding: 8px; margin-bottom: 0;">
                    <option value="">Todos os estados</option>
                    {% for estado in estados_disponiveis %}
                        <option value="{{ estado }}" {% if filtro_estado == estado %}selected{% endif %}>{{ estado }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div>
                <label for="municipio" style="font-weight: 700; color: var(--text-main); display: block; margin-bottom: 5px;">Munic√≠pio:</label>
                <input type="text" name="municipio" id="municipio" 
                       value="{{ filtro_municipio }}" placeholder="Digite o munic√≠pio" 
                       style="width: 100%; padding: 8px; margin-bottom: 0;">
            </div>
            
            <div style="display: flex; gap: 10px; align-items: flex-end;">
                <button type="submit" class="btn-primary" style="width: auto; margin-top: 0; padding: 8px 20px;">
                    Buscar
                </button>
                
                {% if filtro_pais or filtro_estado or filtro_municipio %}
                    <a href="{% url 'ranking' %}?criterio={{ criterio }}{% if is_educador and filtro_turma %}&codigo_turma={{ filtro_turma }}{% endif %}" 
                       class="btn-secondary" style="padding: 8px 15px; text-decoration: none; display: inline-block;">
                        üóëÔ∏è Limpar
                    </a>
                {% endif %}
            </div>
        </form>
    </section>

    {% if is_educador %}
    <section class="info-card" style="margin-bottom: 20px; border: 1px solid var(--primary);">
        <h3 style="margin-bottom: 15px; color: var(--text-main);">üë®‚Äçüè´ Filtro por Turma (Educadores)</h3>
        <form method="GET" style="display: flex; gap: 10px; align-items: center;">
            <input type="hidden" name="criterio" value="{{ criterio }}">
            {% if filtro_pais %}<input type="hidden" name="pais" value="{{ filtro_pais }}">{% endif %}
            {% if filtro_estado %}<input type="hidden" name="estado" value="{{ filtro_estado }}">{% endif %}
            {% if filtro_municipio %}<input type="hidden" name="municipio" value="{{ filtro_municipio }}">{% endif %}
            
            <label for="codigo_turma" style="font-weight: 700; color: var(--text-main);">C√≥digo da Turma:</label>
            <input type="text" name="codigo_turma" id="codigo_turma" 
                   value="{{ filtro_turma }}" placeholder="Ex: ABC-123" 
                   style="margin-bottom: 0; flex: 1; padding: 8px;">
            
            <button type="submit" class="btn-primary" style="width: auto; margin-top: 0; padding: 8px 20px;">
                Buscar
            </button>
            
            {% if filtro_turma %}
                <a href="{% url 'ranking' %}?criterio={{ criterio }}{% if filtro_pais %}&pais={{ filtro_pais }}{% endif %}{% if filtro_estado %}&estado={{ filtro_estado }}{% endif %}{% if filtro_municipio %}&municipio={{ filtro_municipio }}{% endif %}" 
                   style="font-size: 0.8rem; color: var(--text-muted);">Limpar Turma</a>
            {% endif %}
        </form>
    </section>
    {% endif %}

    <section class="ranking-filter-section">
        <h3>Ordenar por:</h3>
        <div class="filter-group">
            <a href="{% url 'ranking' %}?criterio=valuation{% if filtro_turma %}&codigo_turma={{ filtro_turma }}{% endif %}{% if filtro_pais %}&pais={{ filtro_pais }}{% endif %}{% if filtro_estado %}&estado={{ filtro_estado }}{% endif %}{% if filtro_municipio %}&municipio={{ filtro_municipio }}{% endif %}" 
               class="filter-btn {% if criterio == 'valuation' %}active{% endif %}">Valuation</a>
            
            <a href="{% url 'ranking' %}?criterio=saldo{% if filtro_turma %}&codigo_turma={{ filtro_turma }}{% endif %}{% if filtro_pais %}&pais={{ filtro_pais }}{% endif %}{% if filtro_estado %}&estado={{ filtro_estado }}{% endif %}{% if filtro_municipio %}&municipio={{ filtro_municipio }}{% endif %}" 
               class="filter-btn {% if criterio == 'saldo' %}active{% endif %}">Saldo em Caixa</a>
            
            <a href="{% url 'ranking' %}?criterio=turno{% if filtro_turma %}&codigo_turma={{ filtro_turma }}{% endif %}{% if filtro_pais %}&pais={{ filtro_pais }}{% endif %}{% if filtro_estado %}&estado={{ filtro_estado }}{% endif %}{% if filtro_municipio %}&municipio={{ filtro_municipio }}{% endif %}" 
               class="filter-btn {% if criterio == 'turno' %}active{% endif %}">Turno Alcan√ßado</a>
            
            <a href="{% url 'ranking' %}?criterio=conquistas{% if filtro_turma %}&codigo_turma={{ filtro_turma }}{% endif %}{% if filtro_pais %}&pais={{ filtro_pais }}{% endif %}{% if filtro_estado %}&estado={{ filtro_estado }}{% endif %}{% if filtro_municipio %}&municipio={{ filtro_municipio }}{% endif %}" 
               class="filter-btn {% if criterio == 'conquistas' %}active{% endif %}">Conquistas</a>
        </div>
    </section>

    {% if startups %}
    <div class="ranking-table-container">
        <table class="modern-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Empresa</th>
                    <th>Fundador (Tipo)</th>
                    <th>Turma</th>
                    <th class="text-right">Pontua√ß√£o</th>
                    <th class="text-right">Valuation Final</th>
                    <th class="text-right">Saldo</th>
                    <th class="text-center">Turno</th>
                    <th class="text-center">Funcion√°rios</th>
                    <th class="text-center">Conquistas</th>
                </tr>
            </thead>
            <tbody>
                {% for startup in startups %}
                <tr class="{% if startup.partida.usuario == user %}highlight-row{% endif %}">
                    <td class="rank-number">
                        {% if forloop.counter == 1 %}
                            <span class="trophy">ü•á</span><span class="rank-1">1¬∫</span>
                        {% elif forloop.counter == 2 %}
                            <span class="trophy">ü•à</span><span class="rank-2">2¬∫</span>
                        {% elif forloop.counter == 3 %}
                            <span class="trophy">ü•â</span><span class="rank-3">3¬∫</span>
                        {% else %}
                            {{ forloop.counter }}¬∫
                        {% endif %}
                    </td>
                    <td>
                        <span class="company-name">{{ startup.partida.nome_empresa|default:startup.nome }}</span>
                        {% if startup.partida.usuario == user %}<span class="me-badge">VOC√ä</span>{% endif %}
                    </td>
                    <td>
                        {{ startup.partida.usuario.get_full_name|default:startup.partida.usuario.username }}
                        <br>
                        {% if startup.partida.usuario.categoria == 'ESTUDANTE_UNIVERSITARIO' %}
                            <span class="badge-tipo badge-pf">Estudante Universit√°rio</span>
                        {% elif startup.partida.usuario.categoria == 'ASPIRANTE_EMPREENDEDOR' %}
                            <span class="badge-tipo badge-pj">Aspirante a Empreendedor</span>
                        {% elif startup.partida.usuario.categoria == 'EDUCADOR_NEGOCIOS' %}
                            <span class="badge-tipo badge-pj">Educador de Neg√≥cios</span>
                        {% elif startup.partida.usuario.categoria == 'PROFISSIONAL_CORPORATIVO' %}
                            <span class="badge-tipo badge-pj">Profissional Corporativo</span>
                        {% else %}
                            <span class="badge-tipo badge-pf">{{ startup.partida.usuario.get_categoria_display }}</span>
                        {% endif %}
                    </td>
                    
                    <td>
                        {% if startup.partida.usuario.codigo_turma %}
                            <strong style="color: var(--primary);">{{ startup.partida.usuario.codigo_turma }}</strong>
                        {% else %}
                            <span style="color: var(--text-muted);">-</span>
                        {% endif %}
                    </td>
                    
                    <td class="text-right font-bold" style="color: #ff9800; font-size: 1.05rem;">
                        {{ startup.pontuacao_conquistas|default:0 }} ponto{{ startup.pontuacao_conquistas|default:0|pluralize:"s" }}
                    </td>
                    
                    <td class="text-right color-primary {% if criterio == 'valuation' %}font-bold{% endif %}">
                        <strong>{{ startup.valuation|moeda_br }}</strong>
                    </td>
                    
                    <td class="text-right color-success {% if criterio == 'saldo' %}font-bold{% endif %}">
                        {{ startup.saldo_caixa|moeda_br }}
                    </td>
                    
                    <td class="text-center {% if criterio == 'turno' %}font-bold{% endif %}">
                        {{ startup.turno_atual }}
                    </td>
                    
                    <td class="text-center">{{ startup.funcionarios }}</td>
                    
                    <td class="text-center {% if criterio == 'conquistas' %}font-bold{% endif %}">
                        {{ startup.total_conquistas }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <div class="ranking-footer">
        <p>Exibindo top {{ startups|length }} startups ativas.</p>
        {% if user.is_educador %}
            <span class="educator-note">üí° Modo Educador: Visualiza√ß√£o total de perfis PF/PJ habilitada.</span>
        {% endif %}
    </div>

    {% else %}
    <div class="empty-state-container">
        <p class="empty-state">Ainda n√£o h√° startups ativas no ranking.</p>
    </div>
    {% endif %}
</main>

<script>
    document.addEventListener('DOMContentLoaded', function(){
        const alerts = document.querySelectorAll('#top-messages .alert');
        alerts.forEach((el) => {
            setTimeout(()=>{
                el.classList.add('hide');
                setTimeout(()=> el.remove(), 600);
            }, 5000);
        });
    });

</script>
{% endblock %}