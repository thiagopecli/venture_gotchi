{% extends 'base.html' %}

{% block content %}
{% if messages %}
    <div class="messages">
        {% for message in messages %}
            {% if 'success' in message.tags %}
                <div class="alert alert-success">
                    ✅ {{ message }}
                </div>
            {% endif %}
        {% endfor %}
    </div>
{% endif %}
<div class="form-container"> <h2 class="form-title">Criar Nova Conta</h2> <form method="post" action="{% url 'registro' %}" novalidate id="registro-form">
        {% csrf_token %}
        
        {% for field in form %}
            {% if field.name == 'tipo_documento' %}
                <div class="field-group {% if field.errors %}field-error{% endif %}" id="tipo_documento_group" style="display: none;">
                    <label>{{ field.label }}</label>
                    {{ field }}
                    {% if field.errors %}
                        <div class="error-messages">
                            {% for error in field.errors %}
                                <div class="error-item">❌ {{ error }}</div>
                            {% endfor %}
                        </div>
                    {% endif %}
                    {% if field.help_text %}
                        <small class="help-text">{{ field.help_text }}</small>
                    {% endif %}
                </div>
            {% elif field.name == 'documento' %}
                <div class="field-group {% if field.errors %}field-error{% endif %}" id="documento_group" style="display: none;">
                    <label>{{ field.label }}</label>
                    {{ field }}
                    {% if field.errors %}
                        <div class="error-messages">
                            {% for error in field.errors %}
                                <div class="error-item">❌ {{ error }}</div>
                            {% endfor %}
                        </div>
                    {% endif %}
                    {% if field.help_text %}
                        <small class="help-text">{{ field.help_text }}</small>
                    {% endif %}
                </div>
            {% elif field.name == 'codigo_turma' %}
                <div class="field-group {% if field.errors %}field-error{% endif %}" id="codigo_turma_group" style="display: none;">
                    <label>{{ field.label }}</label>
                    {{ field }}
                    {% if field.errors %}
                        <div class="error-messages">
                            {% for error in field.errors %}
                                <div class="error-item">❌ {{ error }}</div>
                            {% endfor %}
                        </div>
                    {% endif %}
                    {% if field.help_text %}
                        <small class="help-text">{{ field.help_text }}</small>
                    {% endif %}
                </div>
            {% elif field.name == 'matricula_aluno' %}
                <div class="field-group {% if field.errors %}field-error{% endif %}" id="matricula_aluno_group">
                    <label>{{ field.label }}</label>
                    {{ field }}
                    {% if field.errors %}
                        <div class="error-messages">
                            {% for error in field.errors %}
                                <div class="error-item">❌ {{ error }}</div>
                            {% endfor %}
                        </div>
                    {% endif %}
                    {% if field.help_text %}
                        <small class="help-text">{{ field.help_text }}</small>
                    {% endif %}
                </div>
            {% elif field.name == 'cpf' %}
                <div class="field-group {% if field.errors %}field-error{% endif %}" id="cpf_group" style="display: none;">
                    <label>{{ field.label }}</label>
                    {{ field }}
                    {% if field.errors %}
                        <div class="error-messages">
                            {% for error in field.errors %}
                                <div class="error-item">❌ {{ error }}</div>
                            {% endfor %}
                        </div>
                    {% endif %}
                    {% if field.help_text %}
                        <small class="help-text">{{ field.help_text }}</small>
                    {% endif %}
                </div>
            {% elif field.name == 'nome_instituicao' %}
                <div class="field-group {% if field.errors %}field-error{% endif %}" id="nome_instituicao_group" style="display: {% if field.errors %}block{% else %}none{% endif %};">
                    <label>{{ field.label }}</label>
                    {{ field }}
                    {% if field.errors %}
                        <div class="error-messages">
                            {% for error in field.errors %}
                                <div class="error-item">❌ {{ error }}</div>
                            {% endfor %}
                        </div>
                    {% endif %}
                    {% if field.help_text %}
                        <small class="help-text">{{ field.help_text }}</small>
                    {% endif %}
                </div>
            {% elif field.name == 'area_atuacao' %}
                <div class="field-group {% if field.errors %}field-error{% endif %}" id="area_atuacao_group" style="display: none;">
                    <label>{{ field.label }}</label>
                    {{ field }}
                    {% if field.errors %}
                        <div class="error-messages">
                            {% for error in field.errors %}
                                <div class="error-item">❌ {{ error }}</div>
                            {% endfor %}
                        </div>
                    {% endif %}
                    {% if field.help_text %}
                        <small class="help-text">{{ field.help_text }}</small>
                    {% endif %}
                </div>
            {% elif field.name == 'cnpj' %}
                <div class="field-group {% if field.errors %}field-error{% endif %}" id="cnpj_group" style="display: none;">
                    <label>{{ field.label }}</label>
                    {{ field }}
                    {% if field.errors %}
                        <div class="error-messages">
                            {% for error in field.errors %}
                                <div class="error-item">❌ {{ error }}</div>
                            {% endfor %}
                        </div>
                    {% endif %}
                    {% if field.help_text %}
                        <small class="help-text">{{ field.help_text }}</small>
                    {% endif %}
                </div>
            {% elif field.name == 'nome_empresa' %}
                <div class="field-group {% if field.errors %}field-error{% endif %}" id="nome_empresa_group" style="display: none;">
                    <label>{{ field.label }}</label>
                    {{ field }}
                    {% if field.errors %}
                        <div class="error-messages">
                            {% for error in field.errors %}
                                <div class="error-item">❌ {{ error }}</div>
                            {% endfor %}
                        </div>
                    {% endif %}
                    {% if field.help_text %}
                        <small class="help-text">{{ field.help_text }}</small>
                    {% endif %}
                </div>
            {% else %}
                <div class="field-group {% if field.errors %}field-error{% endif %}">
                    <label>{{ field.label }}</label>
                    {{ field }}
                    {% if field.errors %}
                        <div class="error-messages">
                            {% for error in field.errors %}
                                <div class="error-item">❌ {{ error }}</div>
                            {% endfor %}
                        </div>
                    {% endif %}
                    {% if field.help_text %}
                        <small class="help-text">{{ field.help_text }}</small>
                    {% endif %}
                </div>
            {% endif %}
        {% endfor %}

        {% if form.non_field_errors %}
            <div class="error">{{ form.non_field_errors }}</div>
        {% endif %}

        <button type="submit" class="btn-primary">Finalizar Cadastro</button>

        <div class="login-link-container">
            Já tem uma conta? <a href="{% url 'login' %}">Voltar ao Login</a>
        </div>
    </form>
</div>

<script>document.addEventListener('DOMContentLoaded', function() {
    const categoriaSelect = document.querySelector('select[name="categoria"]');
    const codigoTurmaGroup = document.getElementById('codigo_turma_group');
    const matriculaAlunoGroup = document.getElementById('matricula_aluno_group');
    const cpfGroup = document.getElementById('cpf_group');
    const nomeInstituicaoGroup = document.getElementById('nome_instituicao_group');
    const areaAtuacaoGroup = document.getElementById('area_atuacao_group');
    const cnpjGroup = document.getElementById('cnpj_group');
    const nomeEmpresaGroup = document.getElementById('nome_empresa_group');

    function toggleFields() {
        const categoria = categoriaSelect.value;
        // Hide all except those already showing errors
        [
            codigoTurmaGroup,
            matriculaAlunoGroup,
            cpfGroup,
            nomeInstituicaoGroup,
            areaAtuacaoGroup,
            cnpjGroup,
            nomeEmpresaGroup
        ].forEach(group => {
            if (!group.classList.contains('field-error')) {
                group.style.display = 'none';
            }
        });

        // Make fields not required
        document.querySelector('input[name="codigo_turma"]').required = false;
        document.querySelector('input[name="matricula_aluno"]').required = false;
        document.querySelector('input[name="cpf"]').required = false;
        document.querySelector('input[name="nome_instituicao"]').required = false;
        document.querySelector('input[name="area_atuacao"]').required = false;
        document.querySelector('input[name="cnpj"]').required = false;
        document.querySelector('input[name="nome_empresa"]').required = false;

        // Show based on category
        if (categoria === 'ESTUDANTE_UNIVERSITARIO') {
            codigoTurmaGroup.style.display = 'block';
            matriculaAlunoGroup.style.display = 'block';
            document.querySelector('input[name="codigo_turma"]').required = true;
            document.querySelector('input[name="matricula_aluno"]').required = true;
        } else if (categoria === 'EDUCADOR_NEGOCIOS') {
            cpfGroup.style.display = 'block';
            nomeInstituicaoGroup.style.display = 'block';
            document.querySelector('input[name="cpf"]').required = true;
            document.querySelector('input[name="nome_instituicao"]').required = true;
        } else if (categoria === 'ASPIRANTE_EMPREENDEDOR') {
            cpfGroup.style.display = 'block';
            areaAtuacaoGroup.style.display = 'block';
            document.querySelector('input[name="cpf"]').required = true;
            document.querySelector('input[name="area_atuacao"]').required = true;
        } else if (categoria === 'PROFISSIONAL_CORPORATIVO') {
            cnpjGroup.style.display = 'block';
            nomeEmpresaGroup.style.display = 'block';
            document.querySelector('input[name="cnpj"]').required = true;
            document.querySelector('input[name="nome_empresa"]').required = true;
        }

        // Ensure groups with server-side errors stay visible even if category is unset
        [codigoTurmaGroup, matriculaAlunoGroup, cpfGroup, nomeInstituicaoGroup, areaAtuacaoGroup, cnpjGroup, nomeEmpresaGroup]
            .forEach(group => {
                if (group.classList.contains('field-error')) {
                    group.style.display = 'block';
                }
            });
    }

    categoriaSelect.addEventListener('change', toggleFields);
    
    // Validação em tempo real para campo CPF - apenas 11 dígitos numéricos
    const cpfInput = document.querySelector('input[name="cpf"]');
    if (cpfInput) {
        cpfInput.addEventListener('input', function(e) {
            // Remove qualquer caractere não-numérico
            e.target.value = e.target.value.replace(/[^\d]/g, '');
            // Limita a 11 dígitos
            if (e.target.value.length > 11) {
                e.target.value = e.target.value.slice(0, 11);
            }
        });
    }
    
    // Validação em tempo real para campo CNPJ - apenas 14 dígitos numéricos
    const cnpjInput = document.querySelector('input[name="cnpj"]');
    if (cnpjInput) {
        cnpjInput.addEventListener('input', function(e) {
            // Remove qualquer caractere não-numérico
            e.target.value = e.target.value.replace(/[^\d]/g, '');
            // Limita a 14 dígitos
            if (e.target.value.length > 14) {
                e.target.value = e.target.value.slice(0, 14);
            }
        });
    }
    
    // Initial check
    toggleFields();
});
</script>
{% endblock %}